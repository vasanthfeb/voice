<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Menu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    <style>
        body {
            background: #f6f7fb
        }
        
        .card {
            border: 0;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .08)
        }
        
        .drop {
            border: 2px dashed #bbb;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            background: white
        }
        
        .drop.dragover {
            border-color: #0d6efd;
            background: #f0f6ff
        }
        
        .range-output {
            min-width: 3ch;
            display: inline-block;
            text-align: right
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <h3 class="m-0">menu</h3>
                <span class="badge text-bg-primary">Client‑side • No upload</span>
            </div>

            <!-- Upload -->
            <div id="drop" class="drop mb-3">
                <p class="mb-1 fw-semibold">Drop an audio file here or click to browse</p>
                <small class="text-muted">Supported: .wav, .mp3, .m4a, .ogg</small><br/>
                <input id="file" type="file" accept="audio/*" class="d-none" />
                <button id="browse" class="btn btn-outline-primary mt-3">Choose File</button>
            </div>

            <!-- Info -->
            <div class="row g-3 mb-3">
                <div class="col-md">
                    <div class="form-floating">
                        <input id="filename" class="form-control" placeholder="File name" disabled />
                        <label for="filename">Selected File</label>
                    </div>
                </div>
                <div class="col-md-auto d-flex align-items-end gap-2">
                    <button id="playOriginal" class="btn btn-secondary" disabled>Play Original</button>
                    <button id="playConverted" class="btn btn-primary" disabled>Play Converted</button>
                    <button id="downloadBtn" class="btn btn-success" disabled>Process & Download</button>
                </div>
            </div>

            <!-- Preset -->
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="presetToggle" checked>
                    <label class="form-check-label" for="presetToggle">Use "Male → Female" preset</label>
                </div>
                <small class="text-muted">Preset sets pitch +5 semitones, lighter lows, brighter highs, soft compression.</small>
            </div>

            <!-- Controls -->
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Pitch shift (semitones): <span id="pitchVal" class="range-output">+5</span></label>
                    <input id="pitch" type="range" class="form-range" min="-12" max="12" step="1" value="5">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Low EQ (dB): <span id="lowVal" class="range-output">-6</span></label>
                    <input id="low" type="range" class="form-range" min="-24" max="12" step="1" value="-6">
                </div>
                <div class="col-md-4">
                    <label class="form-label">High EQ (dB): <span id="highVal" class="range-output">+3</span></label>
                    <input id="high" type="range" class="form-range" min="-12" max="12" step="1" value="3">
                </div>
            </div>

            <div class="row g-3 mt-1">
                <div class="col-md-6">
                    <label class="form-label">Mid EQ (dB): <span id="midVal" class="range-output">0</span></label>
                    <input id="mid" type="range" class="form-range" min="-12" max="12" step="1" value="0">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Output Gain (dB): <span id="gainVal" class="range-output">0</span></label>
                    <input id="gain" type="range" class="form-range" min="-12" max="12" step="1" value="0">
                </div>
            </div>

            <hr class="my-4" />

            <details>
                <summary class="fw-semibold">Tips & notes</summary>
                <ul class="mt-2 mb-0">
                    <li>This is a <em>basic</em> pitch/EQ based conversion. For natural formant shifting, a server model is needed.</li>
                    <li>Try pitch between +3 to +7 semitones. Tweak EQ to taste.</li>
                    <li>Click <strong>Process & Download</strong> to export the converted audio (recorded in real time).</li>
                </ul>
            </details>
        </div>
    </div>

    <script>
        // UI elements
        const drop = document.getElementById('drop');
        const fileInput = document.getElementById('file');
        const browseBtn = document.getElementById('browse');
        const filename = document.getElementById('filename');
        const playOriginalBtn = document.getElementById('playOriginal');
        const playConvertedBtn = document.getElementById('playConverted');
        const downloadBtn = document.getElementById('downloadBtn');

        const presetToggle = document.getElementById('presetToggle');
        const pitch = document.getElementById('pitch');
        const low = document.getElementById('low');
        const mid = document.getElementById('mid');
        const high = document.getElementById('high');
        const gain = document.getElementById('gain');

        const pitchVal = document.getElementById('pitchVal');
        const lowVal = document.getElementById('lowVal');
        const midVal = document.getElementById('midVal');
        const highVal = document.getElementById('highVal');
        const gainVal = document.getElementById('gainVal');

        // Update readouts
        function fmtDb(v) {
            return (v > 0 ? '+' : '') + v
        }

        function updateReadouts() {
            pitchVal.textContent = (pitch.value > 0 ? '+' : '') + pitch.value;
            lowVal.textContent = fmtDb(+low.value);
            midVal.textContent = fmtDb(+mid.value);
            highVal.textContent = fmtDb(+high.value);
            gainVal.textContent = fmtDb(+gain.value);
        };
        ['input', 'change'].forEach(ev => {
            [pitch, low, mid, high, gain].forEach(el => el.addEventListener(ev, updateReadouts));
        });
        updateReadouts();

        // Tone.js nodes (created after file load)
        let originalUrl = null;
        let player = null;
        let pitchShift = null;
        let eq = null;
        let comp = null;
        let outGain = null;

        function applyPreset(enabled) {
            if (!enabled) return;
            pitch.value = 5;
            low.value = -6;
            mid.value = 0;
            high.value = 3;
            gain.value = 0;
            updateReadouts();
            if (pitchShift) {
                pitchShift.pitch = +pitch.value;
            }
            if (eq) {
                eq.low.value = +low.value;
                eq.mid.value = +mid.value;
                eq.high.value = +high.value;
            }
            if (outGain) {
                outGain.gain.value = Tone.dbToGain(+gain.value);
            }
        }

        presetToggle.addEventListener('change', () => applyPreset(presetToggle.checked));

        // Drag and drop
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => drop.addEventListener(ev, preventDefaults));
        drop.addEventListener('dragover', () => drop.classList.add('dragover'));
        drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
        drop.addEventListener('drop', e => {
            drop.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        drop.addEventListener('click', () => fileInput.click());
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        async function handleFiles(files) {
            if (!files || !files[0]) return;
            const file = files[0];
            filename.value = file.name + ` (${(file.size/1024/1024).toFixed(2)} MB)`;

            if (originalUrl) URL.revokeObjectURL(originalUrl);
            originalUrl = URL.createObjectURL(file);

            // Ensure audio context is started by a user gesture
            await Tone.start();

            // Dispose previous graph if any
            [player, pitchShift, eq, comp, outGain].forEach(n => {
                try {
                    n && n.dispose && n.dispose();
                } catch (_) {}
            });

            // Build processing graph
            player = new Tone.Player({
                url: originalUrl,
                autostart: false,
                loop: false
            }).toDestination();
            pitchShift = new Tone.PitchShift({
                pitch: +pitch.value,
                windowSize: 0.1,
                delayTime: 0.01,
                feedback: 0
            });
            eq = new Tone.EQ3({
                low: +low.value,
                mid: +mid.value,
                high: +high.value
            });
            comp = new Tone.Compressor({
                threshold: -18,
                ratio: 3,
                attack: 0.01,
                release: 0.25
            });
            outGain = new Tone.Gain(Tone.dbToGain(+gain.value));

            // Routing: player -> pitch -> eq -> comp -> gain -> destination
            player.disconnect();
            player.connect(pitchShift);
            pitchShift.connect(eq);
            eq.connect(comp);
            comp.connect(outGain);
            outGain.toDestination();

            playOriginalBtn.disabled = false;
            playConvertedBtn.disabled = false;
            downloadBtn.disabled = false;

            if (presetToggle.checked) applyPreset(true);
        }

        // Playback helpers
        function stopAll() {
            if (player) {
                player.stop();
                player.seek(0);
            }
        }

        playOriginalBtn.addEventListener('click', async() => {
            if (!player) return;
            await Tone.start();
            // Temporarily bypass effects by routing player directly to destination
            player.disconnect();
            player.toDestination();
            stopAll();
            player.start();
            // After play, restore processed chain
            player.onstop = () => {
                player.disconnect();
                player.connect(pitchShift);
            };
        });

        playConvertedBtn.addEventListener('click', async() => {
            if (!player) return;
            await Tone.start();
            // Ensure processed routing is active
            player.disconnect();
            player.connect(pitchShift);
            stopAll();
            player.start();
        });

        // Live update processing params
        pitch.addEventListener('input', () => {
            if (pitchShift) pitchShift.pitch = +pitch.value;
        });
        low.addEventListener('input', () => {
            if (eq) eq.low.value = +low.value;
        });
        mid.addEventListener('input', () => {
            if (eq) eq.mid.value = +mid.value;
        });
        high.addEventListener('input', () => {
            if (eq) eq.high.value = +high.value;
        });
        gain.addEventListener('input', () => {
            if (outGain) outGain.gain.value = Tone.dbToGain(+gain.value);
        });

        // Record processed audio in real time and download
        downloadBtn.addEventListener('click', async() => {
            if (!player) return;
            await Tone.start();

            // Ensure processed chain
            player.disconnect();
            player.connect(pitchShift);

            // Recorder taps the signal just before destination
            const recorder = new Tone.Recorder();
            outGain.connect(recorder);

            const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
            recorder.mimeType = mimeType;

            recorder.start();
            stopAll();
            player.start();

            // Wait for playback to finish
            const durMs = player.buffer ? player.buffer.duration * 1000 : 0;
            await new Promise(res => setTimeout(res, durMs + 250));

            const recording = await recorder.stop();
            const blob = new Blob([recording], {
                type: mimeType
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const base = (filename.value || 'converted').split('(')[0].trim().replace(/\.[^/.]+$/, '');
            a.download = `${base}_female_${Date.now()}.${mimeType.includes('webm')?'webm':'ogg'}`;
            document.body.appendChild(a);
            a.click();
            a.remove();

            setTimeout(() => URL.revokeObjectURL(url), 5000);
        });
    </script>
</body>

</html>
